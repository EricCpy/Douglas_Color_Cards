---
title: "Douglas color cards"
author: "Nicolas Hahn, Eric Jonas, Pavlo Kravets, Simon Schäfer"
date: "`r Sys.Date()`"
output: 
  bookdown::gitbook:
    css: "custom.css"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 1, digits = 2)

source("code/setup.R")
full_refit = FALSE
```

# Introduction

The Douglas color cards are used to determine someones skin color to find the most appropriate cosmetics products - e.g. the perfect foundation. They show 64 squares of various colors. The center four squares get punched out.

```{r colorcard, echo=FALSE, warning=FALSE, cache=!full_refit, fig.cap="Master color card", fig.align='center'}
display_color_card(master_colors, "Crow", "Ccol", "Lab", 2)
```

The color cards are placed in front of ones facial skin and a photo is taken. The visual information about the skin color (visible at the four center squares) and the reference color squares is evaluated by an app and the closest skin color type is calculated.

Each sheet contains 42 color cards, each with a QR code. The QR codes allow the app to identify the precise location of each color card on the sheet. Below is a visualization of the first sheet in our dataset.

```{r colorcardsheet, echo=FALSE, warning=FALSE, cache=!full_refit, fig.cap="Color card sheet", fig.align='center'}
display_color_sheet(lab_colors, color_sheet_idx = 1)
```

## Quality assurance

To assure the best skin color typification it is crucial to assure a consistent production of the color cards. Especially the reference color squares colors variance should be as low as possible.

The existence of QR codes indicating the position on a sheet reduces the requirements to meet because thus only the variance of reference color squares at the same position of the sheets have to be as low as possible. Differences between reference color squares among different positions on a sheet can be taken care of in the app once the positional information is evaluated from the QR code.

## Data description

The data given consists of two files. One file holds the master color information given in the Lab colorspace as well as in the CMYKS color space. In the latter S stands for special and might be some kind of skin color pigment.

```{r master_color_data_overview, echo=FALSE, cache=!full_refit}
print(
  summarytools::dfSummary(
    master_colors %>% select(-c(Field, Crow, Ccol, Chroma, Color)), 
    plain.ascii = FALSE, 
    style = "grid",
    graph.magnif = 1.18
    ), 
  method = 'render')
```

The second file holds color information obtained from 13 printed sheets. Thus we find the Lab color information for all 64 squares for 42 color cards for 13 sheets resulting in `r format(64*42*13*3, scientific=FALSE)` numeric values. We transformed the data into long format so we can easily match the colors of each field with those of the master colors.

```{r lab_color_data_overview, echo=FALSE, cache=!full_refit}
print(
  summarytools::dfSummary(
    lab_colors_master_shape %>% select(-c(Field, Crow, Ccol, Sheet, Row, Column)), 
    plain.ascii = FALSE, 
    style = "grid",
    graph.magnif = 1.18
    ), 
  method = 'render')
```

## Color spaces (Pavlo)

Today there are many systems that are used to describe colors. Some of them are device-dependent, such as CMYK and RGB, - they use predefined original colors (for example, ink colors) to create the palette,
others, such as CIE Lab try to approximate human perception of color.

### RGB
RGB is what is known as additive color model - it defines white color as combination of its three components - red, green and blue. It is widely used for light-emitting devices that rely on a combination of smaller elements, such as an LED screen. RGB is device-dependent (its component colors rely on specific elements, such as LED lights), often struggles to portray darker colors, and does not work as well with not light-emitting surfaces. As such, it is not often used in printing.

### CMYK
CMYK (cyan, magenta, yellow and key) is a subtractive color model - white color is absence of its components. It is widely used in printing, and even the word "key" in the name comes from printing - it is used for key plates, a type of device that prints small details. Key color is black, and is used to obtain better black color, more precise print and to save on the expensive inks.

CMYK sometimes struggles to correctly portray light, but saturated colors - it uses technique called halftoning to model light colors, which involves using less ink, which leads to lower saturation.

CMYK is also device-dependent - the result depends on the provided inks. As such, you often cannot easily translate a picture from RGB to CMYK or from one device's CMYK to another. As a result, you need a sort of a "middle ground".

### CIELAB
CIELAB, also known as CIE L\*a\*b is a device-independent color space, designed to mimic human perception of color. In the name CIE stands for International Commission on Illumination (french name is used for an abbreviation), while L, a and b are component axis. L is luminosity, while a and b are two coordinates that define color - they don't have specific color equivalents.

CIELAB found use in many applications - it is used when a conversion between color spaces are needed or when you want to define a palette to be the same across many devices.

### CMYKS

CMYK, as any other additive or subtractive model, can be further modified with additional components - new dyes. For Douglas color system CMYKS, they add additional dye ("Special" for S in CMYKS) that helps to create more accurate skin colors. 

## Objectives

When we encountered the data we formulated three objectives:

a) Analyse where variance or difference in color is noteworthy high / low
b) Visualize variance and differences in colors
c) Use the CMYKS color information to match the Lab color values

According to those objectives we formulated the following questions before exploration of the data:

**a)**

1. Are there especially good / bad cards? (Consistently / target specific) (Pavlo)
1. Is the color difference greater within a sheet (among positions) or across sheets? (Simon Schäfer: R-Code ✔, Text ✔)
1. Is there a difference in dE regarding skin or non skin color / calibration color?  (Pavlov)
1. Color difference of mean over all cards to master target: is it in some uncertainty area? (Eric Jonas: R-Code ✔, Text ✔)
1. Are some Lab values more often in master than in mean? (Eric Jonas: R-Code ✔, Text ✔)
1. How close are CMYK and Lab values? (Eric Jonas: R-Code ✔, Text ✔)
1. Are there colors that are very far off the master target?
1. Are findings on L, a or b also there in dE? (On the subjective meaning)?

**b)**

1. What dE value can be seen on our screen? (Simon Schäfer: R-Code ✔, Text ✔)
1. Can colors on cards be differentiated visually?

**c)**

1. Is there a correlation between dE(CMYK colors, Lab colors) and S? (Eric Jonas: R-Code ✔, Text ✔))
1. How is the color special used (regression)? (Simon / Nico)


# Color difference

One can analyse difference in color in at least three ways:

1. Qualitative: Looking at them - but this takes a while if there are many colors and is depending on subjective perception and lighting or screen
1. Quantitative: Compare the numeric values of each color space dimension
1. Quantitative: Compare all color space dimensions at once with a proper function (i. e. \( \Delta \)E)

## Comparing color space dimensions one by one

In this chapter, we will compare the colorspaces with the master based on their different dimensions. 

To compare the color spaces, we generated a average color card derived from all color cards in our *Lab_Measurement* dataset. 
This average color card serves as a baseline against the reference data of the master. Below is a representation of the average color card. Since the Lab space was created in such a way that linear changes correspond with the changes humans expect we can simply average colors in this space by averaging their three dimensions separately. (For RGB for example one gets a better result using a sum of squares approach.)

```{r averageColorCard, echo=FALSE, warning=FALSE, cache=!full_refit, fig.cap="Average color card", fig.align='center}
display_color_card(mean_lab_color_card, "Row", "Col", "Lab", 2)
```

### Analysis of field discrepancies

```{r colorCardMeanVsMaster, echo=FALSE, warning=FALSE, fig.width=8, fig.height=10, cache=!full_refit, fig.cap="Mean vs master color card dimensions", fig.align='center'}
plot_card_vs_master(mean_lab_color_card, master_colors)
```

Our examination reveals notable fluctuations across various fields. Particularly, the 18th field exhibits significant deviations from the master's data.
Overall, it is evident that the mean of the color cards approximately matches the master in most other fields.

### Analysis of density distributions

Examining the distribution of values across individual channels provides insights into the predominant brightness and color characteristics. The following graphic displays the median density of all cards along with the 95% confidence interval.

```{r colorcardDistributions, echo=FALSE, fig.height=6, warning=FALSE, fig.cap="Mean color card densities", fig.align='center', cache=!full_refit}
plots <- plot_density_vs_master(lab_colors_master_shape, master_colors)
grid.arrange(plots[["L"]], plots[["a"]], plots[["b"]], nrow = 3)
```

The distributions reveal distinct characteristics across the channels: 

- **L dimension:** Notably, there is a leftward shift in values compared to the master, indicating that the dataset tends to have higher brightness levels than the master reference. Additionally, the L channel shows significantly higher variability compared to the other dimensions, where variability is notably low.
- **a dimension:** There is a noticeable deviation from the master particularly around 'a' values near zero, suggesting limitations in accurately representing subtle color variations within this range.
- **b dimension:** Similar to 'a', deviations are observed especially around 'b' values between -10 and 40, indicating representations that differ from the master inside this range.

## Comparing colors with distance function

A function to compare two colors given in Lab color space is \( \Delta \)E - also called dE in this report. Actually there are multiple versions of [Delta E](https://zschuessler.github.io/DeltaE/learn/). The first was given 1976 and just calculates the euclidean distance in the Lab color space:

\[\Delta E_{ab}=\sqrt{(L_2-L_1)^2+(a_2-a_1)^2+(b_2-b_1)^2}\]

In this report we use the most recent \( \Delta \)E formula from 2000. It is much more complex but solves problems when calculating color difference for colors with high lightness value.

The aim of dE is that the calculated distance value can be interpreted in a meaningful way for humans. The following table can be a taken as a guide but there exceptions are possible.

| Delta E   |	Perception                                |
|-----------|-------------------------------------------|
| <= 1.0    | Not perceptible by human eyes.            |
| 1 - 2     | Perceptible through close observation.    |
| 2 - 10    | Perceptible at a glance.                  |
| 11 - 49   | Colors are more similar than opposite     |
| 100       |	Colors are exact opposite                 |

### Color difference on a single card

Comparing the first color cards colors with the master colors shows that there is one color that is pretty far from the master color (3rd row, 2nd column). There are some more fields where we spotted a difference at first glimpse:

* lilac: 8th row, 5th column
* blue: 8th row, 7th column
* dark grey: 7th row, 1st column

The visualization used to compare the colors shows the 64 colors of the color cards according to their position on the color card. In each tile there are two colored circles which show the master color (left circle) and the sample color (right circle). The background color of the tiles corresponds to the dE-value. Light blue indicates a high dE-value. Dark blue ones a low dE-value.

```{r, echo=FALSE, cache=!full_refit}
color_compar_tiles <- function(spotsize, spotdistance, tilesize = 1, tilehighlightcolor = "#000000", lwd = 1) {
  color_differences %>% 
  filter(Sheet == 1, Row == 1, Column == 1) %>% 
  ggplot() +
  geom_tile(aes(fill = Difference, x = Ccol, y = Crow),
            lwd = lwd, width=tilesize, height=tilesize) +
  scale_color_manual(values = c("#FFFFFF00", tilehighlightcolor)) +
  ggnewscale::new_scale_colour() +
  geom_point(aes(x = Ccol+spotdistance, y = Crow, color = Color), size = spotsize) +
  scale_color_identity() +
  geom_point(
    data = master_colors %>% rowwise() %>% mutate(Color = lab_to_rgb(L, a, b)),
    aes(x = Ccol-spotdistance, y = Crow, color = Color), size = spotsize
    ) +
  coord_fixed() +
  labs(caption = "Left circle: master color; Right circle: sample color") +
  xlab("Column") + ylab("Row") +
  theme(
    axis.text=element_text(size=12),
    axis.title=element_text(size=14,face="bold"),
    plot.caption = element_text(size=12, hjust = 0)
    )
}

color_differences_sample_1_1 <- color_differences %>% 
  filter(Sheet == 1, Row == 1, Column == 1)
```

```{r deColorCard, echo=FALSE, fig.width=8, fig.height=8, cache=!full_refit, fig.cap="Master (left circle) compared to first color card (right circle)", fig.align='center'}
color_compar_tiles(spotsize = 11, spotdistance = 0.25)
```

To spot the color difference it is very helpful to let the colors to compare overlap. Thus we can find more colors that are distinguishable by us on our screen. Almost all grey colors are separable from their master color. So are most of the brown colors. Most of the other colors seem to be equal. An exception is the red color (3rd row, 8th column).


```{r deColorCardOverlap, echo=FALSE, fig.width=8, fig.height=8, cache=!full_refit, fig.cap="Master (left circle) compared to first color card (right circle) with overlap", fig.align='center'}
color_compar_tiles(spotsize = 13, spotdistance = 0.175)
```

In order to check if the cut off value of 2 holds for our example we show the same picture again but highlight which colors should be distinguishable in theory. It tells us that we sould be able to spot the difference for the following colors but we did not:

* magenta: 4th row, 8th column
* olive: 1st row, 2nd column
* lavender: 1st row, 5th column

```{r dEColorCardGt2, echo=FALSE, fig.width=8, fig.height=8, cache=!full_refit, fig.cap="Master (left circle) compared to first color card (right circle) with dE greater than two", fig.align='center'}
color_differences_sample_1_1 %>% 
  ggplot() +
  geom_tile(aes(fill = Difference, x = Ccol, y = Crow, color = Difference > 2),
            lwd = 1.5, width=0.95, height=0.95) +
  scale_color_manual(values = c("#FFFFFF00", "#CC3333")) +
  ggnewscale::new_scale_colour() +
  geom_point(aes(x = Ccol+0.175, y = Crow, color = Color), size = 13) +
  scale_color_identity() +
  geom_point(
    data = master_colors %>% rowwise() %>% mutate(Color = lab_to_rgb(L, a, b)),
    aes(x = Ccol-0.175, y = Crow, color = Color), size = 13
    ) +
  coord_fixed() +
  xlab("Column") + ylab("Row") +
  theme(
    axis.text=element_text(size=12),
    axis.title=element_text(size=14,face="bold"),
    plot.caption = element_text(size=12, hjust = 0)
    )
```

Finally we have a look at which color pairs should be no visible difference. Here we found no exception to the rule of thumb given.

```{r dEColorCardLt1, echo=FALSE, fig.width=8, fig.height=8, cache=!full_refit, fig.cap="Master (left circle) compared to first color card (right circle) with dE less than one", fig.align='center'}
color_differences_sample_1_1 %>% 
  ggplot() +
  geom_tile(aes(fill = Difference, x = Ccol, y = Crow, color = Difference < 1),
            lwd = 1.5, width=0.95, height=0.95) +
  scale_color_manual(values = c("#FFFFFF00", "#88CC00")) +
  ggnewscale::new_scale_colour() +
  geom_point(aes(x = Ccol+0.175, y = Crow, color = Color), size = 13) +
  scale_color_identity() +
  geom_point(
    data = master_colors %>% rowwise() %>% mutate(Color = lab_to_rgb(L, a, b)),
    aes(x = Ccol-0.175, y = Crow, color = Color), size = 13
    ) +
  coord_fixed() +
  xlab("Column") + ylab("Row") +
  theme(
    axis.text=element_text(size=12),
    axis.title=element_text(size=14,face="bold"),
    plot.caption = element_text(size=12, hjust = 0)
    )
```

### Correlation \( \Delta \)E with Lab Dimensions

In the previous chapter, we analyzed the difference of \( \Delta \)E across various color fields. This chapter explores the influence of channels on \( \Delta \)E. For the following scatter plots, we chose to exclude field 18 because its \( \Delta \)E value significantly deviates from the other fields, which would disproportionately influence the results.

```{r LabCorrelationsWithDeltaE, echo=FALSE, warning=FALSE, message=FALSE, cache=!full_refit, fig.cap="Lab correlations with dE", fig.align='center'}
mean_lab_color_differences_exlcude_18 <- mean_lab_color_differences %>% 
                                          filter(!(Row == 3 & Col == 2))

grid.arrange(plot_correlation(mean_lab_color_differences_exlcude_18, "L", "Difference"),
             plot_correlation(mean_lab_color_differences_exlcude_18, "a", "Difference"),
             plot_correlation(mean_lab_color_differences_exlcude_18, "b", "Difference"),
             nrow = 3)
```

From the scatter plots, it is evident that there is generally no or very weak linear correlation between \( \Delta \)E and the ab dimensions. This suggests that the perception of color differences may not be solely tied to the individual color channels a and b in a straightforward linear manner. Interestingly, the coefficients highlight a notable correlation between L and \( \Delta \)E values, indicating that brightness differences appear to influence perception in a linear manner.

### Color variance among cards

In order to get a feeling if the color difference compared to the masters colors varies more or less regarding to the color cards position on the sheet or among the sheets at the same position one can have a look at small multiples for both cases. Displaying all color cards of all sheets is possible on a huge screen but not in this report. Anyhow - as one can see - comparing the separated dE tile maps visually is not easy.

Looking at all color cards in a specific position among all 13 sheets shows little difference. Looking at all 42 color cards of a single sheet shows that there might be two slight patterns. One might find a) a light diagonal from bottom left to top right (see cards in first row) or b) a dark diagonal from top left to bottom right (see cards in last row). We will investigate this further with other visualization techniques.

```{r dEColorcardsTopLeftAllSheets, echo=FALSE, fig.width=8, fig.height=8, cache=!full_refit, fig.cap="dE for all color cards at the top left position of all sheets", fig.align='center'}
DeltaE_map_for_sheet(color_differences %>% filter(Row == 1, Column == 1)) +
  facet_wrap(Sheet ~.) +
  theme(
    axis.title = element_blank()
  )
```

```{r dEColorcards1stSheet, echo=FALSE, fig.width=8, fig.height=8, cache=!full_refit, fig.cap="dE for all color cards of the first sheet", fig.align='center'}
DeltaE_map_for_sheet(color_differences %>% filter(Sheet == 1)) +
  facet_grid(Row ~ Column) +
  xlab("Column on sheet") + ylab("Row on sheet")
```

When we are looking at the \( \Delta \)E values for the color cards at target 1-1 (Row-Column) and sheet 1 we find that the color difference tends to be noticeably higher for the color fields at target 1-1 in 20 cases and lower in 10 cases. Especially for the grey fields. The height of the boxes in contrast seems to be lower which is cautiously interpreted as a lower color variance. One has to keep in mind that the boxplots of target 1-1 consist of 13 data points and those of the sheet 1 of 42 data points.

```{r deTargetFirstSheet, echo=FALSE, echo=FALSE, fig.width=8, fig.height=12, cache=!full_refit, fig.cap="dE for target 1-1 of the first sheet", fig.align='center'}
color_dispersion_on_sheet1 <- color_differences %>%
  filter(Sheet == 1) %>% 
  mutate(Aggregated_by = "Sheet")

color_dispersion_on_target1_1 <- color_differences %>%
  filter(Row == 1, Column == 1) %>% 
  mutate(Aggregated_by = "Target")

color_dispersion_on_sheet1 %>% bind_rows(
  color_dispersion_on_target1_1
) %>% filter(Field != 18) %>% 
  ggplot() +
  geom_point(aes(x = 1.5, y = 6, color = Color), size = 8) +
  scale_color_identity() +
  scale_x_discrete() +
  coord_cartesian(ylim = c(0, 6.5)) +
  geom_boxplot(aes(x = Aggregated_by, y = Difference)) +
  facet_grid(Crow ~ Ccol, switch = "both", as.table=FALSE)
```

```{r, echo=FALSE, message=FALSE, cache=!full_refit}
color_dispersion_over_sheets <- color_differences %>% group_by(Sheet, Field) %>% 
  summarise(median_dE = median(Difference), count = n(), mad_dE = mad(Difference)) %>% 
  mutate(Aggregated_by = "Sheet") %>% 
  ungroup()

color_dispersion_over_targets <- color_differences %>% group_by(Field, Row, Column) %>% 
  summarise(median_dE = median(Difference), count = n(), mad_dE = mad(Difference)) %>% 
  mutate(Aggregated_by = "Target") %>% 
  ungroup()

color_dispersion_compare <- color_dispersion_over_sheets %>% bind_rows(
  color_dispersion_over_targets
)
```

In the following graph we show boxplots of the MAD value of color difference comparing the generalized color variance among sheets and targets. Thus we find 13 values for the sheet boxplot and 42 values for the target boxplot this time. We count 25 noticeably higher MAD values for sheets compared with targets MAD values. We find only three color fields where the opposite is the case. Thus we conclude that the color variance among the color cards on a sheet is higher than within color cards at the same target. It seems consequent to generate QR codes to inform the app which color card is scanned. This way the app can compare the detected color of the printed square with a target specific reference color (instead of the master color) for that field.

```{r MADdeAllSheets, echo=FALSE, echo=FALSE, fig.width=8, fig.height=12, cache=!full_refit, fig.cap="MAD dE for all color cards of all sheets", fig.align='center'}
color_dispersion_compare %>% left_join(
  color_differences %>% select(Field, Crow, Ccol, Color) %>% unique(),
  by = join_by(Field)
) %>% #filter(Field != 18) %>% 
  ggplot() +
  geom_point(aes(x = 1.5, y = 2, color = Color), size = 8) +
  scale_color_identity() +
  scale_x_discrete() +
  coord_cartesian(ylim = c(0, 2.5)) +
  geom_boxplot(aes(x = Aggregated_by, y = mad_dE)) +
  facet_grid(Crow ~ Ccol, as.table = FALSE, switch = "both")
```

To complete the analysis we will have a look at the median color differences grouped by sheets and targets as well. Here we find no generalizable trends to report. The means of the median color difference is very close for all color fields. One might point out that median color distances are more spread for targets than for sheets. But this might be explained by the regression to the mean. For the target medians only 13 individual values are used whereas for the sheets 42 values are used. Thus it is less likely to find extreme differences for the sheets medians.

```{r medianDeAllSheets, echo=FALSE, echo=FALSE, fig.width=8, fig.height=12, cache=!full_refit, fig.cap="Median dE for all color cards of all sheets", fig.align='center'}
color_dispersion_compare %>% left_join(
  color_differences %>% select(Field, Crow, Ccol, Color) %>% unique(),
  by = join_by(Field)
) %>% filter(Field != 18) %>% 
  ggplot() +
  geom_point(aes(x = 1.5, y = 6, color = Color), size = 8) +
  scale_color_identity() +
  scale_x_discrete() +
  coord_cartesian(ylim = c(0, 6.5)) +
  geom_boxplot(aes(x = Aggregated_by, y = median_dE)) +
  facet_grid(Crow ~ Ccol, as.table = FALSE, switch = "both")
```

We found no good way to show median color difference and MAD of color variance in one plot. But we think these boxplots might not be very fancy but a classical visualization form that was established for a good reason.

### New Reference colors by targets

```{r, echo=FALSE, cache=!full_refit}
average_color_card_target_1_1 <- lab_colors_master_shape %>% filter(Row == 1, Column == 1) %>% 
  group_by(Ccol, Crow, Field) %>% 
  summarise(L = mean(L), a = mean(a), b = mean(b)) %>% ungroup() %>% 
  arrange(Field) %>% 
  mutate(Difference = generate_color_difference_df(master_colors, .)$Difference) %>% 
  rowwise() %>% mutate(
    Color = lab_to_rgb(L, a, b)
    )

color_differences_from_average_card <- color_differences_sample_1_1 %>% 
  select(-Difference) %>% 
  mutate(Difference = generate_color_difference_df(average_color_card_target_1_1 %>% select(-Difference), .)$Difference)
```

In the following three graphics we want to look at one example on how the average color cards colors differ from the master and from a sample card at the corresponding target position. We begin with a duplicate of graphic where we compare the sampe color card with the master color card.

We find `r sum(color_differences_sample_1_1$Difference > 2)` colors that should be different on first glimpse. The median color difference is `r median(color_differences_sample_1_1$Difference)` (MAD = `r mad(color_differences_sample_1_1$Difference)`).

```{r, echo=FALSE, echo=FALSE, fig.width=8, fig.height=8, cache=!full_refit}
color_differences_sample_1_1 %>% 
  ggplot() +
  geom_tile(aes(fill = Difference, x = Ccol, y = Crow, color = Difference > 2),
            lwd = 1.5, width=0.95, height=0.95) +
  scale_color_manual(values = c("#FFFFFF00", "#CC3333")) +
  ggnewscale::new_scale_colour() +
  geom_point(aes(x = Ccol+0.175, y = Crow, color = Color), size = 13) +
  scale_color_identity() +
  geom_point(
    data = master_colors %>% rowwise() %>% mutate(Color = lab_to_rgb(L, a, b)),
    aes(x = Ccol-0.175, y = Crow, color = Color), size = 13
    ) +
  coord_fixed() +
  labs(caption = "Left circle: master color; Right circle: sample color") +
  xlab("Column") + ylab("Row") +
  theme(
    axis.text=element_text(size=12),
    axis.title=element_text(size=14,face="bold"),
    plot.caption = element_text(size=12, hjust = 0)
    )
```

When comparing the master cards and the average cards color we find pretty similar - even a bit higher values. `r sum(average_color_card_target_1_1$Difference > 2)` colors should be different on first glimpse. The median color difference is `r median(average_color_card_target_1_1$Difference)` (MAD = `r mad(average_color_card_target_1_1$Difference)`).

```{r, echo=FALSE, echo=FALSE, fig.width=8, fig.height=8, cache=!full_refit}
average_color_card_target_1_1 %>% 
  ggplot() +
  geom_tile(aes(fill = Difference, x = Ccol, y = Crow, color = Difference > 2),
            lwd = 1.5, linetype = 1, width=0.9, height=0.9) +
  scale_color_manual(values = c("#FFFFFF00", "#CC3333")) +
  ggnewscale::new_scale_colour() +
  geom_point(aes(x = Ccol+0.175, y = Crow, color = Color), size = 14) +
  scale_color_identity() +
  geom_point(
    aes(x = Ccol-0.175, y = Crow, color = master_colors$Color), size = 14
  ) +
  coord_fixed() +
  labs(caption = "Left circle: master color; Right circle: average colors target 1-1") +
  xlab("Column") + ylab("Row") +
  theme(
    axis.text=element_text(size=12),
    axis.title=element_text(size=14,face="bold"),
    plot.caption = element_text(size=12, hjust = 0)
  )
```

But when we finally compare the color distance from the average color card and a corresponding sample we can see that we are much closer. We find `r sum(color_differences_from_average_card$Difference > 2)` colors that should be different on first glimpse. The median color difference is `r median(color_differences_from_average_card$Difference)` (MAD = `r mad(color_differences_from_average_card$Difference)`). On our screen we couldn't identify any difference at all. Thus the use of the QR code would pay off in this specific example.

```{r, echo=FALSE, echo=FALSE, fig.width=8, fig.height=8, cache=!full_refit}
color_differences_from_average_card %>% 
  ggplot() +
  geom_tile(aes(fill = Difference, x = Ccol, y = Crow, color = Difference > 2),
            lwd = 1.5, width=0.95, height=0.95) +
  scale_color_manual(values = c("#FFFFFF00", "#CC3333")) +
  ggnewscale::new_scale_colour() +
  geom_point(aes(x = Ccol+0.175, y = Crow, color = Color), size = 13) +
  scale_color_identity() +
  geom_point(
    data = average_color_card_target_1_1,
    aes(x = Ccol-0.175, y = Crow, color = Color), size = 13
    ) +
  coord_fixed() +
  labs(caption = "Left circle: average colors target 1-1; Right circle: sample color") +
  xlab("Column") + ylab("Row") +
  theme(
    axis.text=element_text(size=12),
    axis.title=element_text(size=14,face="bold"),
    plot.caption = element_text(size=12, hjust = 0)
    )
```

# Analysis of S in CMYKS

How does the S value, representing skin tone, influence CMYK values? When comparing the Lab Master with the CMYK Master excluding S, a notable difference emerges, suggesting that the S value significantly impacts CMYK values when converted to Lab.

```{r CMYKAndLabMasterColorcard, echo=FALSE, warning=FALSE, cache=!full_refit, fig.cap="Master color card Lab (left) and CMYK (right)", fig.align='center'}
grid.arrange(display_color_card(master_colors, "Crow", "Ccol", "Lab", 2, 12),
             display_color_card(master_colors, "Crow", "Ccol", "CMYK", 2, 12), 
             ncol = 2)
```

A detailed examination is depicted in the graphic below:

```{r CMYKAndLabMasterColorCardDifference, echo=FALSE, warning=FALSE, fig.width=8, fig.height=8, cache=!full_refit, fig.cap="dE of master color card Lab (left) and CMYK (right)", fig.align='center'}
master_colors_cmyk <- master_colors %>%
  rowwise() %>%
  mutate(L = cmyk_to_lab(C, M, Y, K)[1],
         a = cmyk_to_lab(C, M, Y, K)[2],
         b = cmyk_to_lab(C, M, Y, K)[3]) %>%
  as.data.frame()
master_colors_cmyk_differences <- generate_color_difference_df(master_colors, master_colors_cmyk)
plot_card_differences_to_master(master_colors_cmyk_differences, master_colors, spotsize = 13, spotdistance = 0.175)
```

Given the ambiguity in the CMYK-to-Lab conversion method, this chapter explores correlations between Lab values and S values, employing machine learning models to enhance our understanding of S values and their role in CMYK conversion.

**TODO: ADD CONCLUSION (Nico)**

## Analysis of Lab Correlations with S

In this section, we investigate the relationships between S values and Lab values by correlation.

Examining S values reveals that brownish colors tend to have higher S values. The left side of the gradient—from black to white—shows an S value of 0. The tile plots below visualizes this relationship. It illustrates how S values vary across different color points in the dataset.

```{r STilePlot, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8, fig.height=8, cache=!full_refit, fig.cap="S values of the master color card", fig.align='center'}
ggplot(master_colors, aes(x = Ccol, y = Crow)) +
  geom_tile(aes(fill = S), color = "white") +
  scale_fill_gradient(low = "white", high = "#4682B4", name = "S-value") +
  labs(title = "Tile Plot of S-values",
       x = "Column",
       y = "Row") +
  theme_minimal() +
  ggnewscale::new_scale_colour() +
  geom_point(aes(x = Ccol, y = Crow, color = Color), size = 13) +
  scale_color_identity() +
  geom_text(aes(label = S), color = "black")
```

In row 7, column 6 of our master card, we observe brown values with an S value of 0. This suggests that the S value is not crucial for conversion. We hypothesize that the S value might have been used to reduce printing costs. Perhaps it was more economical to use a brown shade for printer cartridges than other CMYK colors and then integrate it into the CMYK color space. The 0 value in row 7, column 6 could be due to the cheapest color mix not being automatically calculated, but manually distributed. However, there is also the possibility of an error in our dataset.

Next, we examine the correlations between individual Lab dimensions (L, a, b, Chroma) and S.

```{r LabCorrelationsWithS, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.height=8, cache=!full_refit, fig.cap="Lab and Chroma correlations with S", fig.align='center'}
grid.arrange(plot_correlation_with_categories(master_colors, "L", "S"),
             plot_correlation_with_categories(master_colors, "a", "S"),
             plot_correlation_with_categories(master_colors, "b", "S"),
             plot_correlation_with_categories(master_colors, "Chroma", "S"),
             ncol = 2, nrow = 2)
```

The L dimension appears to correlate strongly with S values, when excluding cases where S equals 0.
Notably, the S values also show strong correlations with 'a' and 'b' and the strongest correlation with Chroma. Chroma in the Lab color space quantifies the saturation or colorfulness of a color. It measures how far a color is from being neutral (gray). Chroma in the Lab color space is calculated using the formula:

\[ C = \sqrt{a^2 + b^2} \]

where 'a' and 'b' represent the color opponent dimensions in the Lab color model.
Pearson correlations tend to be higher than Spearman rank correlations, implying a predominantly linear relationship between S and Lab values. However, outliers significantly influence Pearson coefficients, challenging the assumption of a straightforward linear dependency between S and Lab values across all data points. Moreover, upon examining the point clouds inside the scatter plots, a quadratic relationship appears to explain the correlation between L and S, while a linear relationship seems to explain the correlation between a and b with S.

From this analysis, we conclude that the color values 'a' and 'b' exert a stronger influence on S than luminance.

## Douglas CMYKS-Formula

The Douglas master color data yields colors in a unique CMYKS space. As previously shown in the comparison between CMYK and Lab, ignoring this value is a bad idea for accurately matching the reference color. In this section, we will develop a CMYKS formula using regression to better explain the S value.  

```{r, echo=FALSE, cache=!full_refit}
color_regression_linear <- lm(data = master_colors, cbind(L, a, b) ~ C + M + Y + K + S)
color_regression <- color_regression_linear
color_differences_regression <- dE(predict(color_regression), master_colors %>% select("L", "a", "b")) %>% 
  data.frame(Difference = .)

# summary(color_regression)
```

With a multivariate multiple linear regression we find `r sum(color_differences_regression > 2)` colors that should be different on first glimpse. The median color difference is `r median(color_differences_regression$Difference)` (MAD = `r mad(color_differences_regression$Difference)`).

```{r regression1, echo=FALSE, fig.width=8, fig.height=8, cache=!full_refit, fig.cap="Master multivariate multiple linear regression Lab (left circles) compared to first color card Lab (right circles)", fig.align='center'}
color_differences %>% 
  filter(Sheet == 1, Row == 1, Column == 1) %>% select(-Difference, -L, -a, -b) %>% bind_cols(
    color_differences_regression, predict(color_regression)
  ) %>% rowwise() %>% mutate(Color = lab_to_rgb(L, a, b)) %>% 
  ggplot() +
  geom_tile(aes(fill = Difference, x = Ccol, y = Crow, color = Difference > 2),
            lwd = 1.5, width=0.95, height=0.95) +
  scale_color_manual(values = c("#FFFFFF00", "#CC3333")) +
  ggnewscale::new_scale_colour() +
  geom_point(aes(x = Ccol+0.175, y = Crow, color = Color), size = 13) +
  scale_color_identity() +
  geom_point(
    data = master_colors %>% rowwise() %>% mutate(Color = lab_to_rgb(L, a, b)),
    aes(x = Ccol-0.175, y = Crow, color = Color), size = 13
    ) +
  coord_fixed() +
  xlab("Column") + ylab("Row") +
  theme(
    axis.text=element_text(size=12),
    axis.title=element_text(size=14,face="bold"),
    plot.caption = element_text(size=12, hjust = 0)
    )
```

```{r, echo=FALSE, cache=!full_refit}
degree <- 3
color_regression_poly <- lm(data = master_colors, cbind(L, a, b) ~ poly(C, degree) + poly(M, degree) + poly(Y, degree) + poly(K, degree) + poly(S, degree))
color_regression <- color_regression_poly
color_differences_regression <- dE(predict(color_regression), master_colors %>% select("L", "a", "b")) %>% 
  data.frame(Difference = .)

# summary(color_regression)
```

With a multivariate multiple polynomial regression with degree `r degree`  we find `r sum(color_differences_regression > 2)` colors that should be different on first glimpse. (38 colors with 2nd degree polynomials.) This are almost as many as with the linear regression. We even find some colors that have been matched better with linear regression. The median color difference is `r median(color_differences_regression$Difference)` (MAD = `r mad(color_differences_regression$Difference)`).

```{r regression2, echo=FALSE, fig.width=8, fig.height=8, cache=!full_refit, fig.cap="Master multivariate multiple polynomial regression Lab (left circles) compared to first color card Lab (right circles)", fig.align='center'}
color_differences %>% 
  filter(Sheet == 1, Row == 1, Column == 1) %>% select(-Difference, -L, -a, -b) %>% bind_cols(
    color_differences_regression, predict(color_regression)
  ) %>% rowwise() %>% mutate(Color = lab_to_rgb(L, a, b)) %>% 
  ggplot() +
  geom_tile(aes(fill = Difference, x = Ccol, y = Crow, color = Difference > 2),
            lwd = 1.5, width=0.95, height=0.95) +
  scale_color_manual(values = c("#FFFFFF00", "#CC3333")) +
  ggnewscale::new_scale_colour() +
  geom_point(aes(x = Ccol+0.175, y = Crow, color = Color), size = 13) +
  scale_color_identity() +
  geom_point(
    data = master_colors %>% rowwise() %>% mutate(Color = lab_to_rgb(L, a, b)),
    aes(x = Ccol-0.175, y = Crow, color = Color), size = 13
    ) +
  coord_fixed() +
  xlab("Column") + ylab("Row") +
  theme(
    axis.text=element_text(size=12),
    axis.title=element_text(size=14,face="bold"),
    plot.caption = element_text(size=12, hjust = 0)
    )
```

```{r, echo=FALSE, cache=!full_refit}
color_regression_interaction_3terms <- lm(data = master_colors %>% select(C, M, Y, K, S, L, a, b), cbind(L, a, b) ~ .^3)
color_regression <- color_regression_interaction_3terms
color_differences_regression <- dE(predict(color_regression), master_colors %>% select("L", "a", "b")) %>% 
  data.frame(Difference = .)

# summary(color_regression)
```

With a multivariate multiple linear regression including interaction terms up to 3rd order we find `r sum(color_differences_regression > 2)` colors that should be different on first glimpse. (Five colors with only 2nd order interaction terms.) The median color difference is `r median(color_differences_regression$Difference)` (MAD = `r mad(color_differences_regression$Difference)`).

```{r regression3, echo=FALSE, fig.width=8, fig.height=8, cache=!full_refit, fig.cap="Master multivariate multiple linear regression with interactions Lab (left circles) comparedto first color card Lab (right circles)", fig.align='center'}
color_differences %>% 
  filter(Sheet == 1, Row == 1, Column == 1) %>% select(-Difference, -L, -a, -b) %>% bind_cols(
    color_differences_regression, predict(color_regression)
  ) %>% rowwise() %>% mutate(Color = lab_to_rgb(L, a, b)) %>% 
  ggplot() +
  geom_tile(aes(fill = Difference, x = Ccol, y = Crow, color = Difference > 2),
            lwd = 1.5, width=0.95, height=0.95) +
  scale_color_manual(values = c("#FFFFFF00", "#CC3333")) +
  ggnewscale::new_scale_colour() +
  geom_point(aes(x = Ccol+0.175, y = Crow, color = Color), size = 13) +
  scale_color_identity() +
  scale_fill_continuous(limits = c(0, 10)) +
  geom_point(
    data = master_colors %>% rowwise() %>% mutate(Color = lab_to_rgb(L, a, b)),
    aes(x = Ccol-0.175, y = Crow, color = Color), size = 13
    ) +
  coord_fixed() +
  xlab("Column") + ylab("Row") +
  theme(
    axis.text=element_text(size=12),
    axis.title=element_text(size=14,face="bold"),
    plot.caption = element_text(size=12, hjust = 0)
    )
```

## Analysis of relationship with machine learning models

**TODO (Nico)**

**Train on part of data and assess performance on testdata (with bootstrap?)**

**Discuss parameter number and learning data: 25 vs 64 for 3rd order interaction (15 vs 64 in 2nd order interaction; 15 vs 64 in 3rd degree polinomial)**